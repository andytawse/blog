<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="utf-8" /><meta name="Generator" content="Drupal 11 (https://www.drupal.org)" /><meta name="MobileOptimized" content="width" /><meta name="HandheldFriendly" content="true" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.andytawse.co.uk/blog/authentication-when-running-google-cloud-run-functions-locally-functions-emulator" /><link rel="shortlink" href="https://www.andytawse.co.uk/node/1" /><title>Authentication when running Google Cloud Run functions locally with Functions Emulator | Andy&#039;s Blog</title><link rel="stylesheet" media="all" href="/sites/default/files/css/css_98cfU8TK4SOL6LJvIuZBUQfgTv_fKFQQx0wNzSc-Hds.css?delta=0&amp;language=en&amp;theme=basicblog&amp;include=eJxLSizOTE7KyU_XT8_JT0rM0S0uqczJzEsHAHWWCX4" /></head><body> <a href="#main-content" class="visually-hidden focusable"> Skip to main content </a><div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas><div class="layout-container"><div data-drupal-messages-fallback class="hidden"></div> <header role="banner"><div id="block-basicblog-site-branding"> <a href="/" rel="home">Andy&#039;s Blog</a></div><nav role="navigation" aria-labelledby="block-basicblog-main-menu-menu" id="block-basicblog-main-menu"><h2 class="visually-hidden" id="block-basicblog-main-menu-menu">Main navigation</h2><ul><li> <a href="/" data-drupal-link-system-path="&lt;front&gt;">Home</a></li><li> <a href="/about-me" data-drupal-link-system-path="node/3">About Me</a></li></ul> </nav><div id="block-basicblog-siteinfo"><div><p>This site is intended to be simple, back-to-basics, low-impact and fast.</p></div></div> </header> <main role="main"> <a id="main-content" tabindex="-1"></a><div class="layout-content"><div id="block-basicblog-page-title"><h1><span>Authentication when running Google Cloud Run functions locally with Functions Emulator</span></h1></div><div id="block-basicblog-content"> <article class="full"> <footer><div> Published: <span><time datetime="2024-11-27T13:42:23+00:00" title="Wednesday, November 27, 2024 - 13:42">27 November 2024</time></span></div> </footer><div><div><p>In short:</p><pre><code class="language-plaintext">gcloud alpha functions local deploy &lt;function-name&gt; --set-env-vars=GOOGLE_APPLICATION_CREDENTIALS=./creds.json
gcloud alpha functions local call &lt;function-name&gt; --impersonate-service-account="&lt;account&gt;"</code></pre><p>This information was difficult to find for me as I find the <a href="https://cloud.google.com/functions/docs/running/functions-emulator">Functions Emulator</a> to be quite immature as a product (it's alpha as it says) and poorly documented, even though it seems like a great idea.</p><p>Google <a href="https://cloud.google.com/docs/authentication/provide-credentials-adc">Application Default Credentials</a> can be set using an environment variable, and because <a href="https://cloud.google.com/functions/docs/running/functions-emulator">Functions Emulator</a> runs in a Docker container, we need to get that env variable set during the deploy. The creds.json file should be a JSON API key for the service user you are running the function as, which you can download from the Google Cloud console.</p><p>It's not ideal having the creds in a file in your codebase. You'll want a .gitignore entry to avoid it being committed to git, but accidents can still happen. This however was the first time I've been able to authenticate when running a cloud function locally, so it's useful for now.</p><h2>Deploy</h2><p>It's also best not to deploy the creds file to Google Cloud. A `.gcloudignore` file can contain a list of files not to deploy (a bit like `.gitignore`). But if we do that, then the creds file won't get deployed locally either, and we need the deployed container to see it (in fact, we <em>only</em> need it locally). The way I've gotten round that is when deploying to live/staging/etc:</p><pre><code class="language-plaintext">gcloud functions deploy ... --ignore-file=.gcloudignore-non-local</code></pre><p>Instead of using a `.gcloudignore` I'm specifying my own ignore file, which contains one line: `creds.json`. Then when I deploy locally, the `.gcloudignore-non-local` is ignored and `creds.json` is seen by the local container</p></div><div class="tags"><div><a href="/taxonomy/term/1" hreflang="en">Google Cloud Run Functions</a></div><div><a href="/taxonomy/term/2" hreflang="en">Google Functions Emulator</a></div></div></div></article></div></div> </main></div></div></body></html>